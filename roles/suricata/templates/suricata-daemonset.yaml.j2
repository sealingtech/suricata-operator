apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ suricata.fullname }}
  namespace: default
  labels:
    app: suricata
spec:
  selector:
    matchLabels:
      app: suricata
  template:
    metadata:
      name: {{ suricata.name }} 
      labels:
        app: suricata
    spec:
      {% if networks.useHostNetworking %}hostNetwork: true{% endif %}

      initContainers:
      - name: verifynode
        image: {{ images.runner }}
        env:
        - name: INTERFACE1
          valueFrom:
            secretKeyRef:
              {% if suricataConfig.inline == true %}
              name: inline-interface1
              {% else -%}
              name: passive-interface
              {% endif %}key: interface
        {%- if suricataConfig.inline == true %}
        
        - name: INTERFACE2
          valueFrom:
            secretKeyRef:
              name: inline-interface2
              key: interface
        {%- endif %}

        - name: STARTUP_SCRIPT
          value: |
            #!/bin/bash
            set -e
            sleep 10
            if [ ! -f /sys/class/net/$INTERFACE/operstate ]; then
            echo "Network interface '$INTERFACE' not found, exiting..."
            exit 1
            fi
            while [ ! -f /var/lib/suricata/rules/suricata.rules ];do 
              echo 'Waiting for Suricata Update to Complete';
              sleep 5; 
            done
            until curl -sSf http://localhost:6379; do 
              sleep 2; 
            done
      containers:
      - name: suricata
        image: {{ images.suricata }}
        command: [ "bash", "-c", "while [ ! -f /var/lib/suricata/rules/suricata.rules ];do echo 'Waiting for Suricata Update to Complete'; sleep 5; done && until curl -sSf http://localhost:6379; do sleep 2; done && rm -rf /etc/suricata/* && cp -rpf -L /tmp/suricata/* /etc/suricata/ && /suricata-entrypoint.sh" ]
        stdin: true
        tty: true
        securityContext:
          privileged: true
          capabilities:
              add:
                - NET_ADMIN
                - SYS_NICE #Needed for CPU pinning
                - NET_RAW
        env: 
          - name: INTERFACE1
            valueFrom: 
              secretKeyRef: 
                {% if suricataConfig.inline == true -%}
                name: inline-interface1
                {% else -%}
                name: passive-interface
                {% endif %}key: interface
          {% if suricataConfig.inline -%}
          - name: INTERFACE2
            valueFrom: 
              secretKeyRef:
                name: inline-interface2
                key: interface
          {%- endif %}

        volumeMounts:
          - mountPath:  /tmp/suricata
            name: suricata-config
          - mountPath: /data/suricata
            name: suricata-logs
          - mountPath: /var/lib/suricata/rules
            name: suricata-rules-pvc
        resources:
          requests:
            cpu: "{{ suricataConfig.requests.cpu }}"
            memory: "{{ suricataConfig.requests.memory }}"
          limits:
            cpu: "{{ suricataConfig.limits.cpu }}"
            memory: "{{ suricataConfig.limits.memory }}"
      - name: redis
        image: {{ images.redis }}
        imagePullPolicy: Always
        ports:
        - name: cport-6379
          containerPort: 6379
        resources:
          requests:
            cpu: "{{ redisConfig.requests.cpu }}"
            memory: "{{ redisConfig.requests.memory }}"
          limits:
            cpu: "{{ redisConfig.limits.cpu }}"
            memory: "{{ redisConfig.limits.memory }}"

      {% if deploymentOptions.deployment == "standalone" -%}
      - name: logstash
        image: {{ images.logstash }}
        imagePullPolicy: Always
        ports:
        - name: cport-5044
          containerPort: 5044
        resources:
          requests:
            cpu: "{{ logstashConfig.requests.cpu }}"
            memory: "{{ logstashConfig.requests.memory }}"
          limits:
            cpu: "{{ logstashConfig.limits.cpu }}"
            memory: "{{ logstashConfig.limits.memory }}"
        volumeMounts:
          - mountPath: /usr/share/logstash/pipeline/
            name: logstash-suricata-pipeline
          - mountPath: /usr/share/logstash/config
            name: logstash-suricata-config
      {%- endif %}

      volumes:
      - name: suricata-logs
        emptyDir: {}
      - name: suricata-config
        configMap:
          name: {{ suricata.fullname }}-config
      - name: suricata-rules-pvc
        persistentVolumeClaim:
          claimName: {{ suricata.fullname }}-rules-pvc
      {% if deploymentOptions.deployment == "standalone" -%}
      - name: logstash-suricata-config
        configMap:
          name: logstash-{{ suricata.fullname  }}-config
      - name: logstash-suricata-pipeline
        configMap:
          name: logstash-{{ suricata.fullname }}-pipeline
     {%- endif %}

      restartPolicy: Always
      {% if networks.use_host_networking %}
      dnsPolicy: ClusterFirstWithHostNet
      {% else %}
      dnsPolicy: ClusterFirst
      {% endif %}

      nodeSelector:
        {{ nodeSelector.label }} : "true"
